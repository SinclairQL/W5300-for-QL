; a4=pointer to (QL format) string representing address to resolve
;

dns_qhl  equ      12                ; DNS header length is 12 bytes
dns_qqt  equ      4                 ; Four bytes at end of a query question
TYPE_A   equ      1
CLASS_IN equ      1
; Calculate the number of bytes required for the dns query message including trailing and leading byte of message string null and dns header
; and query record trailer
; news.lekane.com is converted to 0x04news0x06lekane0x03com0x00 (0xNN a single byte with hex value NN)
         movea.l  d1,a4
         move.w   (a1),d1
         add.b    #dns_qhl+dns_qqt+2,d1
         move.b   #MT_ALCHP,d0
         moveq    #-1,d2            ; Current job
         trap     #1
         tst.l    d0
         beq      alloc_ok
         rts
; a0 now points to allocated buffer area and a1 still points to start of address to resolve
alloc_ok
         movea.l  a0,a2                               ; a2 used as base address for copying into
insert_trailer
         move.w   (a4)+,d1                            ; Length of string that was passed in
         move.w   #TYPE_A,dns_qhl+2(a2,d1.w)          ; query for A records
         move.w   #CLASS_IN,dns_qhl+4(a2,d1.w)        ; Class Internet
fill_header
         move.w   #0,(a2)                             ; Id for query. TODO: fill in ID of current job
         move.w   #1,4(a2)                            ; Number of questions
         move.w   #0,6(a2)                            ; Number of answers
         move.w   #0,8(a2)                            ; Number of authority resource records
         move.w   #0,10(a2)                           ; Number of additional resource records
set_header_flags
         move.w   #0,2(a2)                            ; Reset all flags
         bset     #0,2(a2)                            ; Recursion desired
convert_address
         move.b   #0,dns_qhl+1(a2,d1.w)               ; Terminate the converted string with a null
         tst.w    d1                                  ; If length of string is zero then we are done
         beq      convert_done
         subq.w   #1,d1                               ; Using dbf for looping so number of loops = d1+1
         moveq    #0,d2                               ; d2 = count of characters in current domain name element
copy_loop
         move.b   0(a4,d1.w),d4
         cmpi.b   #'.',d4
         bne      copy_char
         move.b   d2,dns_qhl+1(a2,d1.w)
         moveq    #0,d2
         bra      copy_loop_test
copy_char
         move.b   d4,dns_qhl+1(a2,d1.w)
         addq.b   #1,d2
copy_loop_test
         dbf      d1,copy_loop
         move.b   d2,dns_qhl+1(a2,d1.w)      ; Set the first byte to run length of first element (d1==-1 after loop)
convert_done
         move.b   #MT_RECHP,d0
         trap     #1
         moveq    #0,d0
         rts
